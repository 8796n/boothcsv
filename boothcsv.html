<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="BOOTH宛名CSVをラベル/注文明細として印刷用に整形するローカル実行ツール">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paper-css/0.4.1/paper.css">

  <link rel="stylesheet" href="./css/boothcsv.css">

  <title>BOOTH宛名印刷用CSV帳票化</title>
  <style>
    /* Skip link (視覚的には通常非表示/フォーカス時表示) */
    .skip-link{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden;}
    .skip-link:focus{left:8px;top:8px;width:auto;height:auto;padding:8px 12px;background:#000;color:#fff;z-index:10000;border-radius:4px;text-decoration:none;}
  </style>
</head>

<body class="A4">
<a href="#mainContent" class="skip-link">メインコンテンツへスキップ</a>
<!-- 固定ヘッダー -->
<div class="fixed-header">
  <div class="fixed-header-content">
    <h1 class="fixed-title">BOOTH宛名印刷用CSV帳票化</h1>
    <div class="main-actions">
      <!-- 印刷枚数表示 -->
  <div class="print-count-display" id="printCountDisplay" aria-live="polite">
        <div class="print-count-item">
          <span class="print-count-label">ラベル:</span>
          <span class="print-count-value" id="labelSheetCount">0</span>
          <span class="print-count-unit">枚</span>
        </div>
        <div class="print-count-item">
          <span class="print-count-label">普通紙:</span>
          <span class="print-count-value" id="orderSheetCount">0</span>
          <span class="print-count-unit">枚</span>
        </div>
  <div class="print-count-item" id="customLabelCountItem">
          <span class="print-count-label">カスタム:</span>
          <span class="print-count-value" id="customLabelCount">0</span>
          <span class="print-count-unit">面</span>
        </div>
      </div>
      <!-- CSVダウンロード -->
      <div class="csv-download-wrapper">
        <button type="button" class="btn-compact btn-download" title="BOOTHの注文一覧へ飛びます" onclick="window.open('https://manage.booth.pm/orders?state=paid', '_blank')">
          📥 CSVをダウンロード
        </button>
      </div>
      <!-- ファイル選択 -->
      <div class="file-input-wrapper-compact">
  <button type="button" class="file-input-button-compact" onclick="document.getElementById('file').click()">
          📁 CSVファイルを選択
        </button>
  <input type="file" id="file" name="csvfile" accept=".csv" class="hidden" aria-label="CSVファイル選択">
        <span class="file-selected-info-compact" id="fileSelectedInfoCompact">未選択</span>
      </div>
      <!-- 主要アクションボタン -->
      <div class="main-action-buttons">
        <button id="print-btn" type="button" title="印刷">印刷</button>
      </div>
    </div>
  </div>
</div>

<!-- メインコンテンツ（既存の内容） -->
<main class="main-content" id="mainContent">
<div class="no_print text-center">
  <form method="POST" enctype="multipart/form-data" id="form">
  <table class="form-table">
      <tr>
        <td><label for="labelyn">ラベルシールも印刷する：</label></td>
        <td><input type="checkbox" id="labelyn" name="labelprint" checked></td>
      </tr>
  <!-- showAllOrders 廃止 -->
      <tr>
        <td><label for="sortByPaymentDate">支払い日時で並び替え：</label></td>
        <td><input type="checkbox" id="sortByPaymentDate" name="sortByPaymentDate" title="BOOTHからダウンロードしたCSVは新しい注文が上に来るので、支払いの古い順に並べ替えたい場合はチェックしてください。"></td>
      </tr>
      <tr>
  <td><label for="labelskipnum">ラベルをスキップする面数：</label></td>
        <td><input type="number" min="0" max="43" id="labelskipnum" name="labelskip" value="0"></td>
      </tr>
      <tr>
        <td><label for="customLabelEnable">残りラベルに任意文字列を印刷：</label></td>
        <td><input type="checkbox" id="customLabelEnable" name="customLabelEnable"></td>
      </tr>
      <tr id="customLabelRow">
        <td colspan="2">
          <div class="multiple-custom-labels-config">
            <div class="custom-labels-header">
              <h4>カスタムラベル設定</h4>
              <div class="custom-labels-buttons">
                <button type="button" id="addCustomLabelBtn" class="btn-base btn-success btn-medium">ラベル追加</button>
                <button type="button" id="clearCustomLabelsBtn" class="btn-base btn-danger btn-medium">全削除</button>
              </div>
            </div>
            <div id="customLabelsContainer" class="custom-labels-container">
              <!-- 複数のカスタムラベル項目がここに追加される -->
            </div>
            <div class="custom-labels-summary">
              <div id="customLabelsSummary" class="custom-labels-summary">※残りラベル数に応じて上限が自動調整されます</div>
            </div>
            <!-- カスタムフォント設定セクション -->
            <div class="custom-font-section">
              <h4 onclick="toggleFontSection()" id="fontSectionHeader">
                <span id="fontSectionArrow">▼</span>
                カスタムフォント設定
              </h4>
              <div id="fontSectionContent">
                <div id="fontDropZone"></div>
                <div id="fontManagement">
                  <div class="my-10">
                    <h5 class="subtle-title">アップロード済みフォント</h5>
                    <div id="fontList" class="font-list">
                      <div class="font-list-placeholder text-center">フォントファイルをアップロードしてください</div>
                    </div>
                    <div class="text-center mt-10">
                      <button type="button" id="clearAllFontsButton" class="btn-base btn-danger btn-clear btn-small">全てのカスタムフォントをクリア</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
      </tr>
      <tr>
        <td><label for="orderImageEnable">注文明細に画像を表示：</label></td>
        <td><input type="checkbox" id="orderImageEnable" name="orderImageEnable"></td>
      </tr>
      <tr id="orderImageRow">
        <td colspan="2">
          <div id="imageDropZone" class="dropzone-container text-center"></div>
        </td>
      </tr>
    </table>
  </form>
  <p class="text-center">保存データ操作：
  <button type="button" id="clearAllButton" class="btn-base btn-danger btn-clear">全ての注文データをクリア</button>
    <button type="button" id="backupDBButton" class="btn-base btn-info btn-clear">📥 データバックアップ</button>
    <button type="button" id="restoreDBButton" class="btn-base btn-warning btn-clear">📤 データリストア</button>
    <input type="file" id="restoreDBFile" accept="application/json" style="display:none" />
  </p>
  <div class="text-center my-15">
    <a href="help.html" target="_blank" rel="noopener" class="btn-base btn-success btn-small btn-margin">📚 使い方ガイド</a>
    <a href="help.html#画像機能について" target="_blank" rel="noopener" class="btn-base btn-info btn-small btn-margin">🖼️ 画像機能の説明</a>
    <a href="help.html#カスタムラベル機能について" target="_blank" rel="noopener" class="btn-base btn-warning btn-small btn-margin">🏷️ カスタムラベル機能</a>
  </div>
  <p><a href="https://github.com/8796n/boothcsv" target="_blank" rel="noopener noreferrer">このツールの公開場所</a></p>
</div>
</main> <!-- main-content 終了 -->
<template id="L44">
  <section class="sheet">
      <table class="label44">
      </table>
    </section>
</template>
<!-- 個々のラベルセル用テンプレート（createLabel で利用）。table/tr でラップし td を正しくパースさせる -->
<template id="labelCell">
  <table><tr>
    <td class="qrlabel">
      <div class="qr"></div>
      <div class="ordernum"></div>
      <div class="yamato"></div>
    </td>
  </tr></table>
</template>
<template id="customLabelCell">
  <table><tr>
    <td class="qrlabel custom-mode">
      <div class="custom-wrapper">
        <div class="custom-content"></div>
      </div>
    </td>
  </tr></table>
</template>
<template id="customLabelItem">
  <div class="custom-label-item">
    <div class="custom-label-item-header">
      <div class="custom-label-item-header-left">
        <input type="checkbox" class="custom-label-enabled" checked>
        <label class="custom-label-item-title">印刷する</label>
      </div>
      <button type="button" class="btn-base btn-danger btn-small btn-remove">削除</button>
    </div>
    <div class="custom-label-input-group">
      <div class="custom-label-editor-row">
  <div class="rich-text-editor" contenteditable="true" 
       id="initialCustomLabelEditor"
       placeholder="印刷したい文字列を入力してください..."></div>
        <div class="custom-label-count-group">
          <label>印刷面数：</label>
          <input type="number" min="1" value="1">
        </div>
      </div>
    </div>
  </div>
</template>
<!-- フォント一覧アイテム用テンプレート（JSで複製） -->
<template id="fontListItemTemplate">
  <div class="font-list-item" data-font-name="">
    <div class="font-info">
      <div class="font-name"></div>
      <div class="font-meta"></div>
    </div>
    <button type="button" class="btn-base btn-danger btn-small font-remove-btn" title="このフォントを削除">削除</button>
  </div>
</template>
<!-- QRコード・画像系／カスタムラベル説明テンプレート群 -->
<template id="qrDropPlaceholder">
  <p class="qr-drop-placeholder">Paste QR image here (Ctrl+V)</p>
 </template>
<template id="orderImageDropDefault">
  <p class="order-image-default-msg">注文明細の余白に表示したい画像をここにドロップ or クリックでファイルを選択</p>
</template>
<template id="customLabelsInstructionTemplate">
  <div class="custom-labels-instructions">
    <div class="instructions-content">
      <strong>カスタムラベル設定について：</strong><br>
      • 実際のラベルサイズ: 48.3mm × 25.3mm<br>
      • テキストのみ入力可能<br>
      • 改行: Enterキー<br>
      • 書式設定: 右クリックでコンテキストメニューを表示（太字、斜体、フォントサイズ変更、フォントの変更）
    </div>
  </div>
</template>
<template id="注文明細">
  <section class="sheet">
    <!-- 各注文明細の非印刷パネル（印刷日時の表示と更新/クリア） -->
    <div class="order-print-info no_print">
      <span>印刷日時: <span class="printed-at">未印刷</span></span>
  <button type="button" class="btn-base btn-success btn-small mark-printed">印刷済みにする</button>
  <button type="button" class="btn-base btn-danger btn-small clear-printed-at">未印刷にする</button>
    </div>
    <div class="page">
      <div class="header">
        <p class="title">注文明細</p>
        <div class="topright">
          <p class="注文番号"></p>
        </div>
        <table class="orderdetail">
          <tr>
            <td>郵便番号</td>
            <td class="郵便番号">【あんしんBOOTHパック】</td>
            <td>注文状況</td>
            <td class="注文状況"></td>
          </tr>
          <tr>
            <td>都道府県</td>
            <td class="都道府県">【あんしんBOOTHパック】</td>
            <td>注文日時</td>
            <td class="注文日時"></td>
          </tr>
          <tr>
            <td>住所１</td>
            <td class="市区町村・丁目・番地">【あんしんBOOTHパック】</td>
            <td>支払い日時</td>
            <td class="支払い日時"></td>
          </tr>
          <tr>
            <td>住所２</td>
            <td class="マンション・建物名・部屋番号"></td>
            <td>お支払方法</td>
            <td class="お支払方法"></td>
          </tr>
          <tr>
            <td>氏名</td>
            <td class="氏名">【あんしんBOOTHパック】</td>
            <td>ユーザー識別コード</td>
            <td class="ユーザー識別コード"></td>
          </tr>
          <tr>
            <td>電話番号</td>
            <td class="電話番号">【あんしんBOOTHパック】</td>
          </tr>
        </table>
      </div>
      <table class="items">
        <tr>
          <th>商品ID</th><th>商品名</th><th>数量</th><th>確認</th>
        </tr>
        <template id="商品">
          <tr>
            <td class="商品ID"></td><td class="商品名"></td><td class="数量"></td><td class="確認"></td>
          </tr>
        </template>
        <tr>
          <td class="spacerow" colspan="4">以下余白</td>
        </tr>
      </table>
      <!-- 個別注文画像ドロップゾーン -->
  <div class="individual-order-image-zone">
        <small>この注文専用の画像（グローバル画像より優先されます）</small>
        <div class="individual-image-dropzone"></div>
      </div>
      <!-- 画像表示用のコンテナを追加 -->
      <div class="order-image-container"></div>
    </div>
  </section>
</template>
<div id="dropZoneDefaultContent">
  <p>注文明細の余白に表示したい画像をここにドロップ or クリックでファイルを選択</p>
</div>
<script src="./js/jsQR.js"></script>
<script src="./js/papaparse.min.js"></script>
<script src="./js/storage.js"></script>
<!-- OrderRepository (orders 単一ソース化 Stage B) -->
<script src="./js/order-repository.js"></script>
<!-- 分離されたカスタムラベル & フォント管理モジュール -->
<script src="./js/custom-labels.js"></script>
<script src="./js/custom-labels-font.js"></script>
<script src="./js/boothcsv.js"></script>
</body>

</html>