<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="BOOTH宛名CSVをラベル/注文明細として印刷用に整形するローカル実行ツール">
  
  <!-- Favicon (relative path for file:// and http:// both) -->
  <link rel="icon" href="favicon.ico">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paper-css/0.4.1/paper.css">

  <link rel="stylesheet" href="./css/boothcsv.css">
  <!-- Sidebar styles -->
  <link rel="stylesheet" href="./css/sidebar.css">

  <title>BOOTH宛名印刷用CSV帳票化</title>
  <style>
    /* Skip link (視覚的には通常非表示/フォーカス時表示) */
    .skip-link{position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden;}
    .skip-link:focus{left:8px;top:8px;width:auto;height:auto;padding:8px 12px;background:#000;color:#fff;z-index:10000;border-radius:4px;text-decoration:none;}
  </style>
</head>

<body class="A4">
<a href="#mainContent" class="skip-link">メインコンテンツへスキップ</a>
<!-- 固定ヘッダー -->
<div class="fixed-header">
  <div class="fixed-header-content">
    <div class="fixed-header-left">
      <!-- ハンバーガーメニュー（サイドバー開閉） -->
      <button id="sidebarToggle" class="hamburger-btn no_print" aria-label="設定メニューを開く" aria-controls="appSidebar" aria-expanded="false" title="設定メニュー">
        <span aria-hidden="true">☰</span>
      </button>
  <h1 class="fixed-title" title="BOOTH宛名印刷用CSV帳票化">BOOTH宛名印刷用CSV帳票化</h1>
    </div>
    <div class="main-actions">
      <!-- 印刷枚数表示 -->
  <div class="print-count-display" id="printCountDisplay" aria-live="polite">
        <div class="print-count-item">
          <span class="print-count-label">ラベル:</span>
          <span class="print-count-value" id="labelSheetCount">0</span>
          <span class="print-count-unit">枚</span>
        </div>
        <div class="print-count-item">
          <span class="print-count-label">普通紙:</span>
          <span class="print-count-value" id="orderSheetCount">0</span>
          <span class="print-count-unit">枚</span>
        </div>
  <div class="print-count-item" id="customLabelCountItem">
          <span class="print-count-label">カスタム:</span>
          <span class="print-count-value" id="customLabelCount">0</span>
          <span class="print-count-unit">面</span>
        </div>
      </div>
      <!-- CSVダウンロード -->
      <div class="csv-download-wrapper">
        <button type="button" class="btn-compact btn-download" title="BOOTHの注文一覧へ飛びます" onclick="window.open('https://manage.booth.pm/orders?state=paid', '_blank')">
          📥 CSVをダウンロード
        </button>
      </div>
      <!-- ファイル選択 -->
      <div class="file-input-wrapper-compact">
  <button type="button" class="file-input-button-compact" onclick="document.getElementById('file').click()">
          📁 CSVファイルを選択
        </button>
  <input type="file" id="file" name="csvfile" accept=".csv" class="hidden" aria-label="CSVファイル選択">
        <span class="file-selected-info-compact" id="fileSelectedInfoCompact">未選択</span>
      </div>
      <!-- 主要アクションボタン -->
      <div class="main-action-buttons">
        <button id="print-btn" type="button" title="印刷">印刷</button>
      </div>
    </div>
  </div>
</div>

<!-- メインコンテンツ（既存の内容） -->
<main class="main-content" id="mainContent">
  <!-- メイン領域は純粋なプレビュー/印刷に専念（公開場所リンクはサイドバー下部へ移設） -->
  <!-- Screenshot snap anchors (no_print, invisible) -->
  <div class="snap-anchor no_print" data-snap="main-top" aria-hidden="true"></div>
  <!-- 初回ガイド: CSV未読み込み時のみ表示（JSで非表示制御） -->
  <section id="initialQuickGuide" class="initial-quick-guide no_print" aria-live="polite">
    <h2 class="quick-guide-title">最初の操作は 3 ステップ</h2>
    <ol class="quick-guide-steps">
      <li>① BOOTHで <button type="button" class="btn-compact btn-download" onclick="window.open('https://manage.booth.pm/orders?state=paid','_blank')">📥 CSVをダウンロード</button>して</li>
  <li>② ダウンロードしたファイルを <button type="button" class="file-input-button-compact quick-guide-file-btn" onclick="document.getElementById('file').click()">📁 CSVファイルを選択</button>する</li>
      <li>③ プレビューを確認し <button type="button" class="btn-compact quick-guide-print-dummy" aria-hidden="true" tabindex="-1">印刷</button> を押す</li>
    </ol>
    <p class="quick-guide-note">詳しい説明はサイドバー右上の「使い方ガイド」リンクから確認できます。</p>
    <!-- ファイルプロトコル警告（JSで条件表示） -->
    <div id="fileProtocolWarning" class="protocol-warning" hidden>
      <h3>💡 より便利に使うには</h3>
      <p>現在HTMLファイルを直接開いているため、他サイトからの画像ドラッグ&amp;ドロップが制限されています。</p>
      <p><strong>推奨:</strong> 簡易HTTPサーバー経由でアクセスしてください。</p>
      <details>
        <summary>🪟 Windows - PowerShellスクリプト使用</summary>
        <ol>
          <li>PowerShellでこのフォルダを開く</li>
          <li><strong>実行ポリシーの設定</strong>（初回のみ）<br>
            <code>Set-ExecutionPolicy RemoteSigned -Scope CurrentUser</code></li>
          <li><code>.\boothcsv.ps1</code> を実行</li>
          <li>自動で開かれるブラウザでアクセス</li>
        </ol>
        <p><small>※ 実行ポリシーの設定はセキュリティに影響します。スクリプトの内容を確認してから実行してください。</small></p>
      </details>
      <details>
        <summary>🍎 macOS / 🐧 Linux - Python使用（推奨）</summary>
        <ol>
          <li>ターミナルでこのフォルダを開く</li>
          <li><code>python3 -m http.server 8796</code> を実行</li>
          <li>ブラウザで <code>http://localhost:8796</code> を開く</li>
          <li>使い終わったら <kbd>Ctrl</kbd> + <kbd>C</kbd> で停止</li>
        </ol>
      </details>
      <details>
        <summary>🍎 macOS / 🐧 Linux - シェルスクリプト使用</summary>
        <ol>
          <li>ターミナルでこのフォルダを開く</li>
          <li>初回のみ: <code>chmod +x boothcsv.sh</code></li>
          <li><code>./boothcsv.sh</code> を実行</li>
          <li>自動で開かれるブラウザでアクセス</li>
        </ol>
      </details>
      <details>
        <summary>🌐 その他の方法</summary>
        <div class="alternative-methods">
          <h5>Node.js利用可能な場合:</h5>
          <code>npx http-server -p 8796 -o</code>
          <h5>PHP利用可能な場合:</h5>
          <code>php -S localhost:8796</code>
        </div>
      </details>
    </div>
  </section>
  <template id="processedOrdersPanelTemplate">
    <section id="processedOrdersPanel" class="processed-orders-panel no_print" hidden>
      <div class="processed-orders-header">
        <h3 class="processed-orders-title">処理済み注文一覧</h3>
        <div class="processed-orders-actions">
          <label class="processed-orders-filter">
            <input type="checkbox" id="processedOrdersUnprintedOnly"> 未印刷のみ表示
          </label>
            <div class="processed-orders-action-buttons">
              <button type="button" id="processedOrdersPreviewButton" class="btn-base btn-primary btn-small" disabled>選択した注文を印刷プレビュー</button>
              <button type="button" id="processedOrdersDeleteButton" class="btn-base btn-danger btn-small" disabled>選択した注文を削除</button>
            </div>
        </div>
      </div>
      <div class="processed-orders-table-wrapper">
        <table class="processed-orders-table">
          <thead>
            <tr>
              <th class="col-select"><input type="checkbox" id="processedOrdersSelectAll" aria-label="全て選択"></th>
              <th data-sort="orderNumber" class="sortable">注文番号</th>
              <th data-sort="paymentDate" class="sortable sort-desc">支払い日時</th>
              <th data-sort="printedAt" class="sortable">印刷日時</th>
            </tr>
          </thead>
          <tbody id="processedOrdersBody"></tbody>
        </table>
        <div class="processed-orders-empty" id="processedOrdersEmpty" hidden>保存されている注文はありません。</div>
      </div>
      <div class="processed-orders-footer">
        <div class="processed-orders-pagination">
          <button type="button" id="processedOrdersPrev" class="btn-base btn-small" disabled>前へ</button>
          <span id="processedOrdersPageInfo" class="processed-orders-page-info"></span>
          <button type="button" id="processedOrdersNext" class="btn-base btn-small" disabled>次へ</button>
        </div>
      </div>
    </section>
  </template>
</main> <!-- main-content 終了 -->
<!-- サイドバー/オーバーレイ（初期導入。徐々に設定UIを移設予定） -->
<div id="sidebarOverlay" class="sidebar-overlay no_print" hidden></div>
<aside id="appSidebar" class="sidebar no_print" aria-hidden="true" tabindex="-1">
  <header class="sidebar-header">
    <h2 class="sidebar-title">設定</h2>
    <div>
      <a href="help.html" target="_blank" rel="noopener" class="btn-base btn-success btn-small sidebar-help-btn" title="使い方ガイド（新しいタブ）">📚 使い方ガイド</a>
      <button type="button" id="sidebarPin" class="sidebar-pin" aria-pressed="false" title="ピン留め（ドック表示）">📌</button>
      <button type="button" id="sidebarClose" class="sidebar-close" aria-label="設定メニューを閉じる">×</button>
    </div>
  </header>
  <div class="sidebar-content">
    
    <section class="sidebar-section">
      <h3 class="sidebar-title">基本設定</h3>
      <div class="sidebar-group">
        <label for="labelyn"><input type="checkbox" id="labelyn" name="labelprint"> ラベルシールも印刷する</label>
      </div>
      <div class="sidebar-group">
        <label for="labelskipnum">ラベルをスキップする面数：</label>
        <input type="number" min="0" max="43" id="labelskipnum" name="labelskip" value="0" aria-label="ラベルをスキップする面数">
      </div>
      <div class="sidebar-group">
        <label for="sortByPaymentDate"><input type="checkbox" id="sortByPaymentDate" name="sortByPaymentDate" title="BOOTHからダウンロードしたCSVは新しい注文が上に来るので、支払いの古い順に並べ替えたい場合はチェックしてください。"> 支払い日時で並び替え</label>
      </div>
      <p class="sidebar-note">変更は自動で適用され、プレビューが更新されます。</p>
  </section>
    <section class="sidebar-section">
      <h3 class="sidebar-title">発送通知コメント(コピペ用)</h3>
      <div class="sidebar-group">
        <label for="shippingMessageTemplate">定型文</label>
        <textarea id="shippingMessageTemplate" rows="5" placeholder="発送通知に添えるメッセージを入力してください"></textarea>
      </div>
      <div class="sidebar-group sidebar-button-row">
        <button type="button" id="saveShippingMessageTemplate" class="btn-base btn-success btn-small">保存</button>
        <button type="button" id="copyShippingMessageTemplate" class="btn-base btn-info btn-small">コピー</button>
      </div>
      <p class="sidebar-note">保存すると次回以降も同じ定型文が表示されます。</p>
    </section>
    <section class="sidebar-section">
      <h3 class="sidebar-title">注文明細用画像</h3>
  <div class="snap-anchor no_print" data-snap="image" aria-hidden="true"></div>
      <div class="sidebar-group checkbox-with-help">
        <label for="orderImageEnable"><input type="checkbox" id="orderImageEnable" name="orderImageEnable"> 注文明細に画像を表示</label>
        <a href="help.html#画像機能について" target="_blank" rel="noopener" class="inline-help" title="画像機能の説明（新しいタブ）">説明</a>
      </div>
      <div class="sidebar-group">
        <div id="imageDropZone" class="dropzone-container text-center"></div>
      </div>
    </section>
    <section class="sidebar-section">
      <h3 class="sidebar-title">カスタムラベル</h3>
  <div class="snap-anchor no_print" data-snap="custom-labels" aria-hidden="true"></div>
      <div class="sidebar-group checkbox-with-help">
        <label for="customLabelEnable"><input type="checkbox" id="customLabelEnable" name="customLabelEnable"> 残りラベルに任意文字列を印刷</label>
        <a href="help.html#カスタムラベル機能について" target="_blank" rel="noopener" class="inline-help" title="カスタムラベル機能の説明（新しいタブ）">説明</a>
      </div>
      <!-- カスタムラベル設定ブロック（チェックON時のみ表示） -->
      <div id="customLabelsBlock" class="custom-labels-root" hidden>
        <div class="multiple-custom-labels-config">
          <div class="custom-labels-header">
            <!-- 重複見出しは省略し、操作ボタンのみ配置 -->
            <div class="custom-labels-buttons">
              <button type="button" id="addCustomLabelBtn" class="btn-base btn-success btn-medium">ラベル追加</button>
              <button type="button" id="clearCustomLabelsBtn" class="btn-base btn-danger btn-medium">全削除</button>
            </div>
          </div>
          <div id="customLabelsContainer" class="custom-labels-container">
            <!-- 複数のカスタムラベル項目がここに追加される -->
          </div>
          <div class="custom-labels-summary"><div id="customLabelsSummary" class="custom-labels-summary">最終シートの残り面数: 0面</div></div>
          <!-- カスタムフォント設定セクション -->
          <div class="custom-font-section">
            <div class="snap-anchor no_print" data-snap="custom-fonts" aria-hidden="true"></div>
            <h4 onclick="toggleFontSection()" id="fontSectionHeader">
              <span id="fontSectionArrow">▼</span>
              カスタムフォント設定
            </h4>
            <div id="fontSectionContent">
              <div id="fontDropZone"></div>
              <div id="fontManagement">
                <div class="my-10">
                  <div class="font-list-header">
                    <h5 class="subtle-title">アップロード済みフォント</h5>
                    <button type="button" id="clearAllFontsButton" class="btn-base btn-danger btn-small font-clear-btn" title="全てのカスタムフォントをクリア">全削除</button>
                  </div>
                  <div id="fontList" class="font-list">
                    <div class="font-list-placeholder text-center">フォントファイルをアップロードしてください</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- 保存データ操作（画像とカスタムラベルの下に配置） -->
    <section class="sidebar-section save-data-footer" id="sidebarSaveDataSection">
      <h3 class="sidebar-title">保存データ操作</h3>
      <div class="sidebar-group save-data-buttons" id="sidebarSaveDataControls">
        <button type="button" id="clearAllButton" class="btn-base btn-danger btn-clear">全ての注文データをクリア</button>
        <button type="button" id="backupDBButton" class="btn-base btn-info btn-clear">📥 データバックアップ</button>
        <button type="button" id="restoreDBButton" class="btn-base btn-warning btn-clear">📤 データリストア</button>
        <input type="file" id="restoreDBFile" accept="application/json" class="hidden-input" aria-label="バックアップJSONの選択" />
      </div>
    </section>
  </div>
  <footer class="sidebar-footer">
    <div class="sidebar-footer-links"><a href="https://github.com/8796n/boothcsv" target="_blank" rel="noopener noreferrer">このツールの公開場所</a></div>
    <small>© 8796.jp</small>
  </footer>
  <!-- 今後: 既存フォーム要素（ID維持）を安全に移設 -->
  <!-- 例: #labelyn, #labelskipnum, #sortByPaymentDate, #customLabelEnable, #orderImageEnable など -->
  <!-- 本パネルは @media print で完全非表示 -->
</aside>
<template id="L44">
  <section class="sheet">
  <div class="snap-anchor no_print" data-snap="label-sheet" aria-hidden="true"></div>
      <table class="label44">
      </table>
    </section>
</template>
<!-- 個々のラベルセル用テンプレート（createLabel で利用）。table/tr でラップし td を正しくパースさせる -->
<template id="labelCell">
  <table><tr>
    <td class="qrlabel">
      <div class="qr"></div>
      <div class="ordernum"></div>
      <div class="yamato"></div>
    </td>
  </tr></table>
</template>
<template id="customLabelCell">
  <table><tr>
    <td class="qrlabel custom-mode">
      <div class="custom-wrapper">
        <div class="custom-content"></div>
      </div>
    </td>
  </tr></table>
</template>
<template id="customLabelItem">
  <div class="custom-label-item">
    <div class="custom-label-item-header">
      <div class="custom-label-item-header-left">
        <input type="checkbox" class="custom-label-enabled" checked>
        <label class="custom-label-item-title">印刷する</label>
      </div>
      <button type="button" class="btn-base btn-danger btn-small btn-remove">削除</button>
    </div>
    <div class="custom-label-input-group">
      <div class="custom-label-editor-row">
  <div class="rich-text-editor" contenteditable="true" 
       id="initialCustomLabelEditor"
       placeholder="印刷したい文字列を入力してください..."></div>
          <div class="custom-label-count-group">
          <label>印刷面数：</label>
          <input type="number" min="1" max="99" value="1">
        </div>
      </div>
    </div>
  </div>
</template>
<!-- フォント一覧アイテム用テンプレート（JSで複製） -->
<template id="fontListItemTemplate">
  <div class="font-list-item" data-font-name="">
    <div class="font-info">
      <div class="font-name"></div>
      <div class="font-meta"></div>
    </div>
    <button type="button" class="btn-base btn-danger btn-small font-remove-btn" title="このフォントを削除">削除</button>
  </div>
</template>
<!-- QRコード・画像系／カスタムラベル説明テンプレート群 -->
<template id="qrDropPlaceholder">
  <p class="qr-drop-placeholder">Paste QR image here (Ctrl+V)</p>
</template>
<template id="qrDropPlaceholderHttp">
  <p class="qr-drop-placeholder">QR画像をここにドロップ or ペースト (Ctrl+V)</p>
</template>
<template id="orderImageDropDefault">
  <p class="order-image-default-msg">注文明細の余白に表示したい画像をここにドロップ or クリックでファイルを選択</p>
</template>
<template id="orderImageDropDefaultFile">
  <p class="order-image-default-msg">注文明細の余白に表示したい画像をクリックでファイルを選択 (他サイトからのドラッグ&ドロップは簡易サーバー経由で可能)</p>
</template>
<template id="customLabelsInstructionTemplate">
  <details class="custom-labels-instructions" id="customLabelsHelp">
    <summary>カスタムラベルの使い方</summary>
    <div class="instructions-content">
      <ul>
        <li>ラベル実寸: 48.3mm × 25.3mm</li>
        <li>入力はテキストのみ（複数行可）</li>
        <li>改行: Enter</li>
        <li>書式: 右クリックのメニュー（太字・斜体・サイズ・フォント）</li>
      </ul>
    </div>
  </details>
</template>
<template id="注文明細">
  <section class="sheet">
  <div class="snap-anchor no_print" data-snap="order-page" aria-hidden="true"></div>
    <!-- 各注文明細の非印刷パネル（印刷日時の表示と更新/クリア） -->
    <div class="order-print-info no_print">
      <span>印刷日時: <span class="printed-at">未印刷</span></span>
  <button type="button" class="btn-base btn-success btn-small mark-printed">印刷済みにする</button>
  <button type="button" class="btn-base btn-danger btn-small clear-printed-at">未印刷にする</button>
    </div>
    <div class="page">
      <div class="header">
        <p class="title">注文明細</p>
        <div class="topright">
          <p class="注文番号"></p>
        </div>
        <table class="orderdetail">
          <tr>
            <td>郵便番号</td>
            <td class="郵便番号">【あんしんBOOTHパック】</td>
            <td>注文状況</td>
            <td class="注文状況"></td>
          </tr>
          <tr>
            <td>都道府県</td>
            <td class="都道府県">【あんしんBOOTHパック】</td>
            <td>注文日時</td>
            <td class="注文日時"></td>
          </tr>
          <tr>
            <td>住所１</td>
            <td class="市区町村・丁目・番地">【あんしんBOOTHパック】</td>
            <td>支払い日時</td>
            <td class="支払い日時"></td>
          </tr>
          <tr>
            <td>住所２</td>
            <td class="マンション・建物名・部屋番号"></td>
            <td>お支払方法</td>
            <td class="お支払方法"></td>
          </tr>
          <tr>
            <td>氏名</td>
            <td class="氏名">【あんしんBOOTHパック】</td>
            <td>ユーザー識別コード</td>
            <td class="ユーザー識別コード"></td>
          </tr>
          <tr>
            <td>電話番号</td>
            <td class="電話番号">【あんしんBOOTHパック】</td>
          </tr>
        </table>
      </div>
      <table class="items">
        <tr>
          <th>商品ID</th><th>商品名</th><th>数量</th><th>確認</th>
        </tr>
        <template id="商品">
          <tr>
            <td class="商品ID"></td><td class="商品名"></td><td class="数量"></td><td class="確認"></td>
          </tr>
        </template>
        <tr>
          <td class="spacerow" colspan="4">以下余白</td>
        </tr>
      </table>
      <!-- 個別注文画像ドロップゾーン -->
  <div class="individual-order-image-zone">
        <small>この注文専用の画像（グローバル画像より優先されます）</small>
        <div class="individual-image-dropzone"></div>
      </div>
      <!-- 画像表示用のコンテナを追加 -->
      <div class="order-image-container"></div>
    </div>
  </section>
</template>
<div id="dropZoneDefaultContent">
  <p>注文明細の余白に表示したい画像をここにドロップ or クリックでファイルを選択</p>
</div>
<script src="./js/jsQR.js"></script>
<script src="./js/papaparse.min.js"></script>
<script src="./js/storage.js"></script>
<!-- OrderRepository (orders 単一ソース化 Stage B) -->
<script src="./js/order-repository.js"></script>
<!-- 分離されたカスタムラベル & フォント管理モジュール -->
<script src="./js/custom-labels.js"></script>
<script src="./js/custom-labels-font.js"></script>
<script src="./js/processed-orders-panel.js"></script>
<script src="./js/boothcsv.js"></script>
</body>

</html>