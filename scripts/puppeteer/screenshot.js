#!/usr/bin/env node
const fs = require('fs');
const path = require('path');
const puppeteer = require('puppeteer-core');
const argv = require('minimist')(process.argv.slice(2));
let Jimp; // ÈÅÖÂª∂Ë™≠„ÅøËæº„ÅøÔºàJimp „ÅØ cut ÁîüÊàêÊôÇ„ÅÆ„Åø‰ΩøÁî®Ôºâ

(async ()=>{
  const outDir = path.resolve(argv.out || 'docs/images');
  const html = path.resolve(argv.html || 'boothcsv.html');
  const chromePath = argv.chrome || 'C:/Program Files (x86)/Google/Chrome/Application/chrome.exe' || undefined;

  if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });
  if (!fs.existsSync(html)) {
    console.error('HTML not found:', html);
    process.exit(1);
  }

  const launchOpts = { headless: true, args: ['--no-sandbox','--disable-setuid-sandbox'] };
  if (chromePath) launchOpts.executablePath = chromePath;

  let browser;
  try {
    browser = await puppeteer.launch(launchOpts);
  } catch (e) {
    console.error('Failed to launch browser:', e.message);
    console.error('If you don\'t have Chrome installed, install Chrome or pass --chrome <path>');
    process.exit(1);
  }

  const page = await browser.newPage();

  // „Éñ„É©„Ç¶„Ç∂„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´Âá∫Âäõ„ÇíNode.js„ÅÆ„Ç≥„É≥„ÇΩ„Éº„É´„Å´Ëª¢ÈÄÅ
  page.on('console', msg => {
    for (let i = 0; i < msg.args().length; ++i) {
      console.log(`[Browser] ${i}: ${msg.args()[i]}`);
    }
  });

  await page.goto('http://localhost:8080/' + path.basename(html) + '?debug=1', { waitUntil: 'networkidle2' });
  await page.setViewport({ width: 1300, height: 700 });

  // UI„ÅÆÁä∂ÊÖã„ÇíË®≠ÂÆö„Åô„ÇãÂÖ±ÈÄöÈñ¢Êï∞
  async function setupUI(config) {
    await page.evaluate((cfg) => {
      // Â∑ÆÂàÜÈÅ©Áî®„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
      const log = (...args) => { if (window.DEBUG_SETUP_UI) console.debug('[setupUI]', ...args); };

      // „Çµ„Ç§„Éâ„Éê„ÉºÔºö„Éî„É≥Áïô„ÇÅ„ÅÆON/OFF„ÅßÂà∂Âæ°
      if (cfg.sidebar !== undefined) {
        const sidebarPin = document.getElementById('sidebarPin');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('appSidebar');

        if (cfg.sidebar === true) { // true: „Éî„É≥Áïô„ÇÅ„Åó„Å¶Ë°®Á§∫
          if (sidebar && sidebarPin && !document.body.classList.contains('sidebar-docked')) {
            // „Çµ„Ç§„Éâ„Éê„Éº„ÅåÈñã„ÅÑ„Å¶„ÅÑ„Å™„Åë„Çå„Å∞Èñã„Åè
            if (!sidebar.classList.contains('open') && sidebarToggle) {
              sidebarToggle.click();
              log('sidebarToggle clicked to open sidebar');
            }
            // „Éî„É≥Áïô„ÇÅ„Åô„Çã
            sidebarPin.click();
            log('sidebarPin clicked to dock sidebar');
          }
        } else { // false: „Éî„É≥Áïô„ÇÅ„ÇíËß£Èô§„Åó„Å¶ÈùûË°®Á§∫
          if (sidebarPin && document.body.classList.contains('sidebar-docked')) {
            sidebarPin.click();
            log('sidebarPin clicked to undock sidebar');
          }
        }
      }

      // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÔºàÂ§âÊõ¥ÊôÇ„ÅÆ„ÅøÔºâ
      const checkboxes = {
        labelyn: cfg.labelyn,
        customLabelEnable: cfg.customLabel,
        orderImageEnable: cfg.orderImage
      };
      for (const [id, value] of Object.entries(checkboxes)) {
        if (value !== undefined) {
          const elem = document.getElementById(id);
          if (elem && elem.checked !== value) {
            elem.checked = value;
            elem.dispatchEvent(new Event('change'));
            log('checkbox changed', id, '->', value);
          }
        }
      }

      // labelskipnum ÔºàÊï∞ÂÄ§ÊñáÂ≠óÂàóÊØîËºÉÔºâ
      const skipVal = (
        cfg.labelSkip !== undefined ? cfg.labelSkip :
        (cfg.labelskip !== undefined ? cfg.labelskip : cfg.labelskipnum)
      );
      if (skipVal !== undefined) {
        const skipInput = document.getElementById('labelskipnum');
        if (skipInput) {
          const newValStr = String(skipVal);
          if (skipInput.value !== newValStr) {
            skipInput.value = newValStr;
            skipInput.dispatchEvent(new Event('input', { bubbles: true }));
            skipInput.dispatchEvent(new Event('change', { bubbles: true }));
            log('labelskipnum changed ->', newValStr);
          }
        }
      }

      // CSV„Éï„Ç°„Ç§„É´„ÅÆ„ÇØ„É™„Ç¢ÔºàÂ∑ÆÂàÜ‰∏çË¶Å„ÄÇÂ∏∏„Å´Á©∫„Å´„Åô„ÇãÊåáÁ§∫„ÅÆ„Å®„Åç„ÅÆ„ÅøÔºâ
      if (cfg.clearFile) {
        const fileInput = document.getElementById('file');
        if (fileInput && fileInput.value !== '') {
          fileInput.value = '';
          log('file input cleared');
        }
      }
    }, config);

    // labelskipnum ÈÅ©Áî®Âæå„ÅÆ„É©„Éô„É´ÂÜçÁîüÊàêÂÆå‰∫Ü„ÇíÁ∞°ÊòìÁöÑ„Å´ÂæÖ„Å§ÔºàÊó¢„Å´ CSV „ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çã„Ç±„Éº„ÇπÔºâ
    if (config && (config.labelSkip !== undefined || config.labelskip !== undefined || config.labelskipnum !== undefined)) {
      try {
        // Áõ¥Âæå„ÅØ autoProcessCSV „ÅåËµ∞„Çã„ÅÆ„Åß„É©„Éô„É´„Ç∑„Éº„ÉàÊï∞„ÅÆ DOM Â§âÂåñ„ÇíÁü≠ÊôÇÈñìÁõ£Ë¶ñ
        await page.waitForFunction(() => {
          // settingsCache „ÅÆÂèçÊò†„Å®ÊúÄ‰Ωé1„Éï„É¨„Éº„É†ÁµåÈÅé„ÇíÊúüÂæÖ
          return !!window.settingsCache && typeof window.settingsCache.labelskip === 'number';
        }, { timeout: 500 });
      } catch(_) {}
    }
  }

  // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÊíÆÂΩ±Èñ¢Êï∞
  async function shot(name, snapName, config) {
    console.log('üëâ Capturing:', name);
    
    // UIÁä∂ÊÖã„ÇíË®≠ÂÆö
    if (config.ui) {
      await setupUI(config.ui);
      await new Promise(r => setTimeout(r, 500)); // UIÊõ¥Êñ∞ÂæÖ„Å°
    }

    // ËøΩÂä†„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„ÉóÂá¶ÁêÜ
    if (config.setup) {
      try {
        await page.evaluate(config.setup);
        await new Promise(r => setTimeout(r, config.setupDelay || 500));
      } catch(e) {
        console.warn('Setup failed:', e.message);
      }
    }

    // „Éì„É•„Éº„Éù„Éº„Éà„Çµ„Ç§„Ç∫„ÅÆË™øÊï¥
    if (config.viewport) {
      await page.setViewport({
        width: config.viewport.width || 1570,
        height: config.viewport.height || 1200
      });
    }

    // snap-anchor„Éô„Éº„Çπ„ÅÆÊíÆÂΩ±
    const rect = await page.evaluate(async (snapName, options = {}) => {
      let target;
      const targetName = options.targetSelector || snapName;

      // „Çø„Éº„Ç≤„ÉÉ„ÉàË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çã„Åæ„ÅßÂæÖÊ©ü
      for (let i = 0; i < 30; i++) {
        if (options.targetSelector) {
          target = document.querySelector(options.targetSelector);
        } else if (snapName) {
          // Ë§áÊï∞„ÅÆ„Ç¢„É≥„Ç´„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Éì„É•„Éº„Éù„Éº„ÉàÂÜÖ„ÅßÊúÄÂàù„Å´Ë¶ã„Å§„Åã„Çã„ÇÇ„ÅÆ„Çí‰ΩøÁî®
          const anchors = document.querySelectorAll(`.snap-anchor[data-snap="${snapName}"]`);
          let visibleAnchor = null;
          for (const anchor of anchors) {
            const rect = anchor.getBoundingClientRect();
            // „Éì„É•„Éº„Éù„Éº„ÉàÂÜÖ„Å´„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (rect.top >= 0 && rect.top < window.innerHeight) {
              visibleAnchor = anchor;
              break;
            }
          }
          // „Éì„É•„Éº„Éù„Éº„ÉàÂÜÖ„ÅÆ„Ç¢„É≥„Ç´„Éº„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÊúÄÂàù„ÅÆ„Ç¢„É≥„Ç´„Éº„Çí‰ΩøÁî®
          const anchor = visibleAnchor || anchors[0];
          if (anchor) {
            target = anchor.closest('section.sheet') || anchor.parentElement;
          }
        }
        if (target) break;
        await new Promise(r => setTimeout(r, 100));
      }
      
      if (!target) {
        console.warn(`Target not found for: ${targetName}`);
        return null;
      }
      
      // template„Çø„Ç∞„Çí„Çπ„Ç≠„ÉÉ„Éó
      while (target && target.tagName === 'TEMPLATE') {
        target = target.parentElement;
      }
      
      if (!target) {
        console.warn(`Target not found for: ${targetName} after template skip`);
        return null;
      }

      // „Éì„É•„Éº„Éù„Éº„Éà„Å´Âèé„ÇÅ„Çã
      target.scrollIntoView({ behavior: 'instant', block: 'center' });
      await new Promise(r => setTimeout(r, 200)); // „Çπ„ÇØ„É≠„Éº„É´ÂæÖ„Å°
      
      const rect = target.getBoundingClientRect();
      if (rect.width === 0 || rect.height === 0) {
        console.warn(`Invalid dimensions for: ${targetName}`);
        return null;
      }

      // Êã°Âºµ„Çª„É¨„ÇØ„ÇøÔºà„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„Å™„Å©Ôºâ„ÇíÂê´„ÇÅ„Çã
      let x = rect.left, y = rect.top, w = rect.width, h = rect.height;
      
      if (options.expandSelectors) {
        options.expandSelectors.forEach(sel => {
          const el = document.querySelector(sel);
          if (!el) return;
          const r = el.getBoundingClientRect();
          if (r.width === 0 || r.height === 0) return;
          x = Math.min(x, r.left);
          y = Math.min(y, r.top);
          const x2 = Math.max(x + w, r.right);
          const y2 = Math.max(y + h, r.bottom);
          w = x2 - x;
          h = y2 - y;
        });
      }

      // „Éë„Éá„Ç£„É≥„Ç∞
      const padding = options.padding || 10;
      x -= padding;
      y -= padding;
      w += padding * 2;
      h += padding * 2;

      return {
        x: Math.max(0, Math.round(x)),
        y: Math.max(0, Math.round(y)),
        width: Math.round(w),
        height: Math.round(h)
      };
    }, snapName, config.snapOptions);

    // ÊúÄÁµÇÂá∫Âäõ„ÅÆ„Åø: rect „Åå„ÅÇ„Çå„Å∞„Éï„É´„Çπ„ÇØ„É™„Éº„É≥„Çí„Éê„ÉÉ„Éï„Ç°ÂèñÂæó‚Üícrop‚Üí name „Åß‰øùÂ≠ò„ÄÇÁÑ°„Åë„Çå„Å∞„Åù„ÅÆ„Åæ„Åæ name „Åß‰øùÂ≠ò„ÄÇ
    const outPath = path.join(outDir, name);
    const ext = path.extname(name).toLowerCase();

    if (rect) {
      const vp = page.viewport();
      rect.width = Math.min(rect.width, vp.width - rect.x);
      rect.height = Math.min(rect.height, vp.height - rect.y);
      try {
        // „Éï„É´„Éì„É•„Éº„Éù„Éº„Éà„Çí„Éê„ÉÉ„Éï„Ç°ÂèñÂæó
        const fullBuffer = await page.screenshot({ type: ext === '.jpg' || ext === '.jpeg' ? 'jpeg' : undefined });
        if (!Jimp) Jimp = require('jimp');
        const img = await Jimp.read(fullBuffer);
        const safeW = Math.min(rect.width, img.bitmap.width - rect.x);
        const safeH = Math.min(rect.height, img.bitmap.height - rect.y);
        if (safeW > 0 && safeH > 0) {
          img.crop(rect.x, rect.y, safeW, safeH);
          await img.writeAsync(outPath);
          console.log(`‚úî Saved cropped (${safeW}x${safeH}) ->`, outPath);
        } else {
          // ÂπÖÈ´ò„Åï‰∏çÊ≠£„Å™„Çâ„Åù„ÅÆ„Åæ„Åæ‰øùÂ≠ò
            await fs.promises.writeFile(outPath, fullBuffer);
            console.warn('Crop skipped (invalid dims). Saved full viewport instead.');
        }
      } catch (e) {
        console.error('Final screenshot (crop) failed:', e.message);
      }
    } else {
      try {
        await page.screenshot({ path: outPath, type: ext === '.jpg' || ext === '.jpeg' ? 'jpeg' : undefined });
        console.log('‚úî Saved (no rect fallback):', outPath);
      } catch (e) {
        console.error('Final screenshot (no rect) failed:', e.message);
      }
    }
  }

  // „Çπ„ÇØ„É™„Éº„É≥„Ç∑„Éß„ÉÉ„ÉàÂÆöÁæ©
  const shots = [
    {
      name: 'main-interface.png',
      ui: {
        sidebar: true,
        labelyn: true,
        customLabel: false,
        orderImage: false,
        clearFile: true
      }
    },
    {
      name: 'custom-labels.png',
      snap: 'custom-labels',
      ui: {
        sidebar: true,
        labelyn: true,
        customLabel: true,
        orderImage: false,
        labelSkip: 1  // „É©„Éô„É´„Çπ„Ç≠„ÉÉ„ÉóÊï∞„Çí0„Å´Ë®≠ÂÆö
      },
      setup: () => {
        // „É™„ÉÉ„ÉÅ„ÉÜ„Ç≠„Çπ„Éà„Ç®„Éá„Ç£„Çø„Å´„Çµ„É≥„Éó„É´„ÉÜ„Ç≠„Çπ„Éà„ÇíÊåøÂÖ•
        const editor = document.querySelector('.rich-text-editor');
        if (editor) {
          editor.innerHTML = '<div><b>„Äê„Çµ„É≥„Éó„É´ÂïÜÂìÅ„Äë</b></div><div>„Ç¢„ÇØ„É™„É´„Ç≠„Éº„Éõ„É´„ÉÄ„Éº</div><div style="color: #666;">ÂïÜÂìÅ„Ç≥„Éº„Éâ: AKH-001</div>';
          editor.dispatchEvent(new Event('input', {bubbles: true}));
          
          // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„ÇíË°®Á§∫
          setTimeout(() => {
            const bold = editor.querySelector('b');
            if (bold) {
              const range = document.createRange();
              range.selectNodeContents(bold);
              const sel = window.getSelection();
              sel.removeAllRanges();
              sel.addRange(range);
              
              const rect = bold.getBoundingClientRect();
              const evt = new MouseEvent('contextmenu', {
                bubbles: true,
                cancelable: true,
                view: window,
                button: 2,
                clientX: rect.left + 10,
                clientY: rect.top + 10
              });
              bold.dispatchEvent(evt);
            }
          }, 300);
        }
      },
      setupDelay: 1000,
      snapOptions: {
        expandSelectors: ['.custom-label-context-menu'],
        padding: 6
      }
    },
    {
      name: 'custom-labels-sheet.png',
      snap: 'label-sheet',
      ui: {
        sidebar: false,  // „Çµ„Ç§„Éâ„Éê„Éº„ÇíÈñâ„Åò„Çã
        labelyn: true,
        customLabel: true,
        orderImage: false
      },
      setup: () => {
        // „Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
        document.querySelectorAll('.custom-label-context-menu').forEach(n => n.remove());
        const editor = document.querySelector('.rich-text-editor');
        if (editor) editor.blur();
        window.getSelection().removeAllRanges();
      },
      viewport: { height: 1400 }
    },
    {
      name: 'custom-fonts.png',
      snap: 'custom-fonts',
      ui: {
        sidebar: true,
        labelyn: true,
        customLabel: true,
        orderImage: false
      },
      setup: () => {
        // „Éï„Ç©„É≥„Éà„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈñã„Åè
        const content = document.getElementById('fontSectionContent');
        if (content) {
          content.style.maxHeight = 'none';
          content.style.overflow = 'visible';
          content.hidden = false;
        }
      }
    },
    {
      name: 'image-function.png',
      snap: 'image',
      ui: {
        sidebar: true,
        labelyn: true,
        customLabel: false,
        orderImage: true
      }
    },
    {
      name: 'image-dropzone.png',
      snap: 'image',
      ui: {
        sidebar: true,
        labelyn: true,
        customLabel: false,
        orderImage: true
      },
      setup: async () => {
        // „Çµ„É≥„Éó„É´ÁîªÂÉè„Çí„É≠„Éº„Éâ
        try {
          const res = await fetch('/sample/footersample.png');
          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          if (window.orderImageDropZone && window.orderImageDropZone.setImage) {
            window.orderImageDropZone.setImage(url, await blob.arrayBuffer());
          }
        } catch(e) {
          console.warn('Image load failed:', e);
        }
      }
    },
    {
      name: 'csv-labels.png',
      snap: 'label-sheet',
      ui: {
        sidebar: false,
        labelyn: true,
        customLabel: false,
        orderImage: true
      },
      setup: async () => {
        // ÂÖ®„Å¶„ÅÆ„Ç∑„Éº„Éà„Çí„ÇØ„É™„Ç¢
        document.querySelectorAll('section.sheet').forEach(s => s.remove());
        
        // CSV„Éï„Ç°„Ç§„É´„Çí„É≠„Éº„Éâ
        try {
          const resCsv = await fetch('/sample/booth_orders_sample.csv');
          const blobCsv = await resCsv.blob();
          const fileCsv = new File([blobCsv], 'booth_orders_sample.csv');
          const input = document.getElementById('file');
          const dt = new DataTransfer();
          dt.items.add(fileCsv);
          Object.defineProperty(input, 'files', {value: dt.files});
          input.dispatchEvent(new Event('change'));
          console.log('CSV file loaded for csv-labels');
        } catch(e) {
          console.warn('CSV load failed:', e);
        }

        // QR„Ç≥„Éº„ÉâÁîªÂÉè„Çí„É≠„Éº„Éâ„Åó„Å¶ÊúÄÂàù„ÅÆ„Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„Å´Ë®≠ÂÆö
        try {
          await new Promise(r => setTimeout(r, 1500)); // CSVÂá¶ÁêÜ„ÇíÂ∞ë„ÅóÂæÖ„Å§
          const dropzone = document.querySelector('.dropzone');
          if (!dropzone) {
            console.warn('QR dropzone not found');
            return;
          }
          const resQr = await fetch('/sample/qrcodedsample.png');
          const blobQr = await resQr.blob();
          const urlQr = URL.createObjectURL(blobQr);
          const img = document.createElement('img');
          img.src = urlQr;
          img.style.maxWidth = '100%';
          img.style.height = 'auto';
          await new Promise(resolve => {
            img.onload = () => {
              dropzone.innerHTML = '';
              dropzone.appendChild(img);
              if (typeof window.readQR === 'function') {
                window.readQR(img); // QR„Ç≥„Éº„Éâ„ÇíË™≠„ÅøÂèñ„Çâ„Åõ„Çã
              }
              console.log('QR code image loaded into first dropzone');
              resolve();
            };
            img.onerror = () => {
              console.warn('QR image could not be loaded into img tag');
              resolve();
            }
          });
        } catch(e) {
          console.warn('QR Code image load failed:', e);
        }
      },
      setupDelay: 2500
    },
    {
      name: 'csv-orders.png',
      snap: 'order-page',
      ui: {
        sidebar: false,
        labelyn: true,
        customLabel: false,
        orderImage: true
      }
    },
    {
      name: 'usage-guide.png',
      ui: {
        sidebar: true,
        labelyn: true,
        customLabel: true,
        orderImage: true
      }
    }
  ];

  // È†ÜÁï™„Å´ÂÆüË°å
  for (const shotConfig of shots) {
    // targetSelector„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅsnapName„Çíundefined„Å®„Åó„Å¶Ê∏°„Åô
    const snapName = shotConfig.snapOptions?.targetSelector ? undefined : shotConfig.snap;
    await shot(shotConfig.name, snapName, shotConfig);
    await new Promise(r => setTimeout(r, 1000));
  }

  await browser.close();
  console.log('All done. Images saved to', outDir);
})();